function esvm_get_closest_matches(models, imgsDir, trainList, topk, varargin)
% Gives 'topk' number of best matches to the e-svm 'models' from imgsDir
% models : models generated by esvm_train_single_exemplar or voc etc
% imgsDir : (string) path of corpus directory
% trainList : fpath to file with training images. Set as [] to use all images
% to retrieve from.
% topk : number of top results to return
%
% (c) Rohit Girdhar

p = inputParser;
addOptional(p, 'res_folder', 'res');
% just search in head_trainFile top elements of the trainFile.
% Useful when passing bow outputs
addOptional(p, 'head_trainFile', -1);
addOptional(p, 'query_fpath', -1); % REQUIRED for 3dp code
parse(p, varargin{:});
addpath(genpath('.'));

endings = '((.jpg)|(.png)|(.gif)|(.JPEG)|(.JPG)|(.jpeg)|(.bmp))$';
if isempty(trainList)
    frpaths = getAllFiles(imgsDir); % recursive search img files relative to imgsDir
    imgFilesOrNot = regexp(frpaths, endings);
    frpaths(cellfun(@isempty, imgFilesOrNot)) = []; % keep only image files
else
    [fid, err] = fopen(trainList);
    if fid == -1
        fprintf('Unable to open %s due to %s\n', trainList, err);
    end
    frpaths = textscan(fid, '%s\n');
    frpaths = frpaths{1};
    flter = cellfun(@(x)~isempty(x), ...
            regexp(frpaths, endings, 'ONCE'));
    frpaths = frpaths(flter, :);
    fclose(fid);
end
if p.Results.head_trainFile > 0
    frpaths = frpaths(1 : p.Results.head_trainFile);
end

params = esvm_get_default_params;
params.dataset_params.localdir = p.Results.res_folder;
params.dataset_params.display = 0;
params.write_bb = 1; % write the bounding boxes in output (top.txt) file
fullpaths = cellfun(@(x) fullfile(imgsDir, x), frpaths, 'UniformOutput', false);
local_detections = esvm_detect_imageset(fullpaths, models, params);
result_struct = esvm_pool_exemplar_dets(local_detections, models, [], params);
%if all(p.Results.query_fpath ~= -1)
%    esvm_rerank_3dp(result_struct, models, fullpaths, ...
%            p.Results.query_fpath, topk, params);
%end

[dir_path, imgs_dirname, ~] = fileparts(imgsDir);
if isempty(imgsDir) && ~isempty(dir_path)  % happens when a trailing backslash
    [~, imgs_dirname, ~] = fileparts(dir_path);
end
esvm_show_top_dets(result_struct, local_detections, ...
                              fullpaths, models, ...
                              params,  topk, imgs_dirname);

