function esvm_get_closest_matches(models, imgsDir, trainList, topk, varargin)
% Gives 'topk' number of best matches to the e-svm 'models' from imgsDir
% models : models generated by esvm_train_single_exemplar or voc etc
% imgsDir : (string) path of corpus directory
% trainList : fpath to file with training images. Set as [] to use all images
% to retrieve from.
% topk : number of top results to return
%
% (c) Rohit Girdhar

p = inputParser;
addOptional(p, 'res_folder', 'res');
parse(p, varargin{:});
addpath(genpath('.'));

if isempty(trainList)
    endings = '((.jpg)|(.png)|(.gif)|(.JPEG)|(.JPG)|(.jpeg)|(.bmp))$';
    frpaths = getAllFiles(imgsDir); % recursive search img files relative to imgsDir
    imgFilesOrNot = regexp(frpaths, endings);
    frpaths(cellfun(@isempty, imgFilesOrNot)) = []; % keep only image files
else
    [fid, err] = fopen(trainList);
    if fid == -1
        fprintf('Unable to open %s due to %s\n', trainList, err);
    end
    frpaths = textscan(fid, '%s\n');
    frpaths = frpaths{1};
    fclose(fid);
end

params = esvm_get_default_params;
params.dataset_params.localdir = p.Results.res_folder;
fullpaths = cellfun(@(x) fullfile(imgsDir, x), frpaths, 'UniformOutput', false);
local_detections = esvm_detect_imageset(fullpaths, models, params);
result_struct = esvm_pool_exemplar_dets(local_detections, models, [], params);
[~, imgs_dirname, ~] = fileparts(imgsDir);
esvm_show_top_dets(result_struct, local_detections, ...
                              fullpaths, models, ...
                              params,  topk, imgs_dirname);

